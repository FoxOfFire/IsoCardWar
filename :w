from random import randint
from typing import Optional, Tuple

import esper

from common import SETTINGS_REF, Action, ActionDecor, ActionEnt

from .log import logger
from .map import MAP_DATA_REF
from .tile import TerrainEnum, Tile, UnitTypeEnum


def get_ent_tile(ent: ActionEnt) -> Optional[Tile]:
    if ent is None:
        return None
    tile = esper.try_component(ent, Tile)
    if tile is None:
        return None
    return tile


def get_change_target_tile_action(terrain: TerrainEnum) -> Action:
    @ActionDecor
    def change_target_tile(args: ActionEnt) -> bool:
        tile = get_ent_tile(args)
        if tile is None:
            return False
        tile.terrain = terrain
        logger.info(tile.terrain)
        return True

    return change_target_tile


@ActionDecor
def rotate_target_tile(args: ActionEnt) -> bool:
    tile = get_ent_tile(args)
    if tile is None:
        return False
    terrain = TerrainEnum(tile.terrain.value % len(list(TerrainEnum)) + 1)
    return get_change_target_tile_action(terrain)(args, True)


def get_change_target_unit_action(
    unit: Optional[UnitTypeEnum], modify_empty_only: bool
) -> Action:
    @ActionDecor
    def change(args: ActionEnt) -> bool:
        logger.info(f"set unit to {unit}")
        tile = get_ent_tile(args)
        if tile is None:
            return False
        if modify_empty_only and tile.unit is not None:
            return False
        if tile.target is not None:
            target = get_ent_tile(tile.target)
            if target is None:
                return False
            target.is_targeted = max(0,target.is_targeted-1)
            tile.target = None
        tile.unit = unit
        return True

    return change


@ActionDecor
def switch_unit_types(ent: ActionEnt) -> bool:
    ent_tile = get_ent_tile(ent)
    if ent_tile is None:
        return False

    target = ent_tile.target
    target_tile = get_ent_tile(target)
    if target_tile is None:
        return False

    logger.info(f"switch units {ent} - {target}")
    ent_unit = ent_tile.unit
    target_unit = target_tile.unit
    if not get_change_target_unit_action(ent_unit, False)(target):
        return False
    if not get_change_target_unit_action(target_unit, False)(ent):
        get_change_target_unit_action(target_unit, False)(target)
        return False
    return True


def get_set_target_tile_target_action(pos: Tuple[int, int]) -> Action:
    @ActionDecor
    def action(ent: ActionEnt) -> bool:
        ent_tile = get_ent_tile(ent)
        if ent_tile is None:
            return False

        logger.info(f"set target to {pos}")
        target = MAP_DATA_REF.ent_at(pos)
        target_tile = esper.component_for_entity(target, Tile)
        target_tile.is_targeted += 1
        ent_tile.target = target
        return True

    return action


def get_spawn_unit_at_random(
    roll_size: int, chance: int, unit: UnitTypeEnum
) -> Action:
    @ActionDecor
    def action(ent: ActionEnt) -> bool:
        if randint(0, roll_size) < chance:
            return get_change_target_unit_action(unit, True)(ent)
        return False

    return action


@ActionDecor
def set_random_target(ent: ActionEnt) -> bool:
    return get_set_target_tile_target_action(
        (
            randint(0, SETTINGS_REF.ISO_MAP_WIDTH - 1),
            randint(0, SETTINGS_REF.ISO_MAP_HEIGHT - 1),
        )
    )(ent)


@ActionDecor
def reset_tile_target(ent: ActionEnt) -> bool:
    if ent is None or not esper.has_component(ent, Tile):
        return False
    tile = esper.component_for_entity(ent, Tile)
    if tile.target is None:
        return False
    target_tile = esper.component_for_entity(tile.target, Tile)
    target_tile.is_targeted = max(0,target_tile.is_targeted-1)
    tile.target = None
    return True


def transfer_action_to_tile_target(action: Action) -> Action:
    @ActionDecor
    def sub_action(ent: ActionEnt) -> bool:
        tile = get_ent_tile(ent)
        if tile is None:
            return True
        return action(tile.target)

    return sub_action
